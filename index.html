<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>Tower Gacha: Permadeath</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0e0e16">
<style>
  :root {
    --bg:#14141e; --panel:#1d1d2a; --text:#f5f7ff; --muted:#b3b6c9;
    --acc:#6ae0ff; --good:#5ee075; --bad:#ff6a6a; --warn:#ffd56a;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto; }
  #app{max-width:700px;margin:0 auto;padding:12px 12px 80px;}
  h1{font-size:22px;margin:10px 0 6px}
  .card{background:var(--panel);border-radius:14px;padding:12px;margin:10px 0;box-shadow:0 6px 20px rgba(0,0,0,.4)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .space{height:6px}
  button{background:#252535;color:var(--text);border:1px solid #34344a;border-radius:12px;padding:12px 14px;font-size:16px}
  button.primary{background:linear-gradient(135deg,#2b3e5a,#1f6b7d);border:none}
  button:active{transform:scale(.98)}
  .pill{padding:6px 10px;border-radius:999px;background:#252535;color:var(--muted);font-size:13px}
  .stars{letter-spacing:2px}
  .log{max-height:180px;overflow:auto;background:#12121a;border-radius:10px;padding:10px;border:1px solid #2a2a3a}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .stat{font-size:14px;color:var(--muted)}
  .bar{height:10px;background:#0f0f18;border-radius:8px;overflow:hidden}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,#6ae0ff,#a6ffe4)}
  .center{text-align:center}
  .enemy{border:1px solid #3a3a52}
  .artifact{border:1px dashed #3a3a52}
  .foot{position:fixed;bottom:0;left:0;right:0;background:rgba(13,13,20,.9);backdrop-filter: blur(6px);padding:10px;border-top:1px solid #2a2a3a}
</style>
</head>
<body>
<div id="app">
  <div class="card center">
    <h1>🗼 Tower Gacha: Permadeath</h1>
    <div class="pill">موت دائم • غاشا خفيف • تسلق طوابق</div>
    <div class="space"></div>
    <div id="menu">
      <p>اختر بطلًا عبر الاستدعاء (غاشا). إذا متّ… تُعاد الرحلة من البداية. حطم أفضل طابق لك!</p>
      <div class="space"></div>
      <button class="primary" onclick="gacha()">🎲 استدعاء أبطال</button>
      <div class="space"></div>
      <div>أفضل طابق: <b id="best">0</b></div>
    </div>
  </div>

  <div id="gacha" class="card" style="display:none">
    <h1>🎴 اختر بطلك</h1>
    <div id="gachaList" class="grid"></div>
    <div class="space"></div>
    <button onclick="backToMenu()">رجوع</button>
  </div>

  <div id="run" style="display:none">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>الطابق <b id="floor">1</b></div>
        <div>📜 القطع الأثرية: <span id="artCount">0</span></div>
        <div>🏅 أفضل طابق: <span id="best2">0</span></div>
      </div>
      <div class="space"></div>
      <div class="row">
        <div class="card enemy" style="flex:1">
          <div class="row" style="justify-content:space-between">
            <div>👾 <b id="eName"></b></div><div class="pill">ATK <span id="eAtk"></span></div>
          </div>
          <div class="stat">HP <span id="eHp"></span>/<span id="eHpMax"></span></div>
          <div class="bar"><span id="eHpBar" style="width:100%"></span></div>
        </div>
        <div class="card" style="flex:1">
          <div class="row" style="justify-content:space-between">
            <div>🧑‍🚀 <b id="pName"></b> <span class="stars" id="pStars"></span></div>
            <div class="pill" id="pClass"></div>
          </div>
          <div class="stat">HP <span id="pHp"></span>/<span id="pHpMax"></span></div>
          <div class="bar"><span id="pHpBar" style="width:100%"></span></div>
          <div class="stat">ATK <span id="pAtk"></span> • DEF <span id="pDef"></span> • SPD <span id="pSpd"></span></div>
          <div class="stat">مهارة: <b id="pSkill"></b> (<span id="skillCd">جاهزة</span>)</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h1>الأوامر</h1>
      <div class="grid">
        <button onclick="actAttack()" class="primary">⚔️ هجوم</button>
        <button onclick="actSkill()">✨ مهارة</button>
        <button onclick="actDefend()">🛡️ دفاع</button>
        <button onclick="actRetreat()">🏳️ هروب</button>
      </div>
      <div class="space"></div>
      <div class="log" id="log"></div>
    </div>

    <div id="rewards" class="card artifact" style="display:none">
      <h1>🏵️ اختر قطعة أثرية</h1>
      <div id="artifactList" class="grid"></div>
    </div>
  </div>

</div>

<div class="foot row center">
  <div style="flex:1">نصيحة: المهارة أفضل ضد الزعماء، لكن حافظ على التبريد!</div>
  <button onclick="installPWA()">⬇️ تثبيت</button>
</div>

<script>
// --- State ---
let state = {
  best: parseInt(localStorage.getItem('tg_best')||'0',10),
  floor: 1, artifacts: [], hero:null, enemy:null, skillCd:0, defending:false
};
const classes = [
  {name:'محارب', key:'warrior', skill:'ضربة قاضية (250% ضرر)', mult: {hp:1.2, atk:1.1, def:1.1, spd:1.0}, cd:3},
  {name:'رامي', key:'archer',  skill:'سيل السهام (3×100%)', mult: {hp:1.0, atk:1.25, def:0.9, spd:1.1}, cd:3},
  {name:'ساحر', key:'mage',    skill:'انفجار سحري (200% يتجاهل 50% دفاع)', mult: {hp:0.9, atk:1.35, def:0.8, spd:1.0}, cd:4},
  {name:'فارس', key:'knight',  skill:'اندفاع درعي (150% + درع مؤقت)', mult: {hp:1.3, atk:1.0, def:1.3, spd:0.9}, cd:4}
];
const names = ['ليان','سِران','كِيان','أروى','غسّان','ليث','ريم','هالة','نايف','نديم','تارا','نيرف','جواد','سيا','ماهر','لين'];
const starRates = [ // cumulative
  {stars:1,p:0.5},{stars:2,p:0.8},{stars:3,p:0.95},{stars:4,p:0.995},{stars:5,p:1.0}
];
const artifactsPool = [
  {name:'خاتم الصيّاد',desc:'+10% هجوم', apply:h=>h.atk*=1.10},
  {name:'وشاح الفولاذ',desc:'+12% دفاع', apply:h=>h.def*=1.12},
  {name:'قلب العنقاء (مقيد)',desc:'+15% نقاط حياة كحد أقصى (لا يُحيي)', apply:h=>h.hpMax*=1.15},
  {name:'عقد السرعة',desc:'+8% سرعة', apply:h=>h.spd*=1.08},
  {name:'كتاب التركيز',desc:'-1 تبريد المهارة (حد أدنى 1)', apply:h=>h.cd=Math.max(1,h.cd-1)},
  {name:'سيف العاصفة',desc:'مهارة تسبب +40% ضرر', apply:h=>h.skillMult*=1.4},
  {name:'درع الوصاية',desc:'الدفاع يقلل ضرر العدو 60%', apply:h=>h.defendRed=0.6}
];

function $(id){return document.getElementById(id);}
function log(t){const el=$('log'); el.innerHTML += '<div>• '+t+'</div>'; el.scrollTop=el.scrollHeight;}
function rnd(){return Math.random();}
function pick(arr){return arr[Math.floor(rnd()*arr.length)];}

function saveBest(){ localStorage.setItem('tg_best', String(state.best)); $('best').textContent=state.best; $('best2').textContent=state.best; }

function backToMenu(){
  $('gacha').style.display='none';
  $('menu').style.display='block';
}

function gacha(){
  $('menu').style.display='none';
  $('gacha').style.display='block';
  const list = $('gachaList'); list.innerHTML='';
  for(let i=0;i<3;i++){
    const cls = pick(classes);
    const roll = rnd();
    let stars = 1;
    for (const r of starRates){ if (roll<=r.p){ stars=r.stars; break; } }
    const base = 50 + stars*25;
    const hero = {
      name: pick(names),
      class: cls.name, clsKey: cls.key, skill: cls.skill, cdBase: cls.cd, cd: cls.cd,
      stars, skillMult: 1.0, defendRed: 0.5,
      hpMax: Math.floor(base*cls.mult.hp),
      atk: Math.floor(base*cls.mult.atk*0.8),
      def: Math.floor(base*cls.mult.def*0.7),
      spd: Math.floor(10*cls.mult.spd)
    };
    hero.hp = hero.hpMax;
    const card = document.createElement('div');
    card.className='card';
    card.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div><b>${hero.name}</b> <span class="stars">${'★'.repeat(hero.stars)}</span></div>
        <div class="pill">${hero.class}</div>
      </div>
      <div class="stat">HP ${hero.hpMax} • ATK ${hero.atk} • DEF ${hero.def} • SPD ${hero.spd}</div>
      <div class="stat">مهارة: <b>${hero.skill}</b> (تبريد ${hero.cdBase})</div>
      <div class="space"></div>
      <button class="primary">اختر</button>
    `;
    card.querySelector('button').onclick = ()=>startRun(hero);
    list.appendChild(card);
  }
}

function startRun(hero){
  state.floor=1; state.artifacts=[]; state.hero=hero; state.skillCd=0; state.defending=false;
  $('gacha').style.display='none';
  $('run').style.display='block';
  $('rewards').style.display='none';
  $('pName').textContent = hero.name;
  $('pStars').textContent = '★'.repeat(hero.stars);
  $('pClass').textContent = hero.class;
  $('pSkill').textContent = hero.skill;
  updateHero();
  nextEnemy();
  $('log').innerHTML=''; log('بدأت الرحلة!');
}

function updateHero(){
  const h = state.hero;
  $('pHp').textContent = Math.max(0,Math.floor(h.hp));
  $('pHpMax').textContent = Math.floor(h.hpMax);
  $('pAtk').textContent = Math.floor(h.atk);
  $('pDef').textContent = Math.floor(h.def);
  $('pSpd').textContent = Math.floor(h.spd);
  $('pHpBar').style.width = Math.max(0, (h.hp/h.hpMax*100))+'%';
  $('skillCd').textContent = state.skillCd>0 ? ('تبريد: '+state.skillCd) : 'جاهزة';
  $('artCount').textContent = state.artifacts.length;
  $('floor').textContent = state.floor;
  $('best2').textContent = state.best;
}

function nextEnemy(){
  const f = state.floor;
  const hp = Math.floor(80 + f*35 * (1 + (f%10===0?1.2:0)));
  const atk = Math.floor(20 + f*8);
  const name = f%10===0 ? 'زعيم الطابق' : pick(['ظِل محارب','آكل نُفوس','حارس الطابق','ساحر غامض','هيكل عظمي']);
  state.enemy = {name, hpMax:hp, hp:hp, atk};
  $('eName').textContent = state.enemy.name;
  $('eHp').textContent = state.enemy.hp;
  $('eHpMax').textContent = state.enemy.hpMax;
  $('eAtk').textContent = state.enemy.atk;
  $('eHpBar').style.width = '100%';
}

function enemyTurn(){
  const e = state.enemy, h = state.hero;
  if (e.hp<=0) return;
  let dmg = Math.max(1, Math.floor(e.atk - h.def*0.3));
  if (state.defending) dmg = Math.floor(dmg * (h.defendRed||0.5));
  h.hp -= dmg;
  log(`👾 العدو يلحق ${dmg} ضررًا!`);
  state.defending=false;
  if (h.hp<=0){
    h.hp=0; updateHero(); death();
  } else {
    updateHero();
  }
}

function actAttack(){
  const h=state.hero, e=state.enemy;
  let dmg = Math.max(1, Math.floor(h.atk - e.atk*0.1));
  e.hp -= dmg;
  log(`⚔️ هاجمت وألحقت ${dmg} ضررًا.`);
  postPlayerAction();
}

function actSkill(){
  const h=state.hero, e=state.enemy;
  if (state.skillCd>0){ log('⏳ المهارة في تبريد.'); return; }
  let dmg=0;
  if (h.clsKey==='warrior'){ dmg = Math.floor(h.atk*2.5); }
  if (h.clsKey==='archer'){ dmg = Math.floor(h.atk*1.0)*3; }
  if (h.clsKey==='mage'){ dmg = Math.floor(h.atk*2.0 + h.atk*0.5); /* ignore def abstracted */ }
  if (h.clsKey==='knight'){ dmg = Math.floor(h.atk*1.5); state.defending=true; }
  dmg = Math.floor(dmg * (h.skillMult||1));
  e.hp -= dmg;
  log(`✨ استخدمت المهارة وألحقت ${dmg} ضررًا!`);
  state.skillCd = h.cd;
  postPlayerAction();
}

function actDefend(){
  state.defending=true;
  log('🛡️ اتخذت وضعية الدفاع (ضرر أقل في هجمة العدو القادمة).');
  postPlayerAction();
}

function actRetreat(){
  log('🏳️ انسحبت… انتهت الرحلة.');
  gameOver(false);
}

function postPlayerAction(){
  const e=state.enemy, h=state.hero;
  if (state.skillCd>0) state.skillCd--;
  if (e.hp<=0){
    e.hp=0;
    $('eHp').textContent=e.hp; $('eHpBar').style.width='0%';
    log('🏁 هزمت العدو!');
    // rewards
    state.floor++;
    if (state.floor-1 > state.best){ state.best = state.floor-1; saveBest(); }
    rewardPhase();
  } else {
    $('eHp').textContent = e.hp; $('eHpBar').style.width = (e.hp/e.hpMax*100)+'%';
    // enemy acts
    setTimeout(enemyTurn, 200);
  }
  updateHero();
}

function rewardPhase(){
  $('rewards').style.display='block';
  const list = $('artifactList'); list.innerHTML='';
  const opts = [];
  while (opts.length<3){
    const a = pick(artifactsPool);
    if (!opts.includes(a)) opts.push(a);
  }
  for (const a of opts){
    const btn = document.createElement('button');
    btn.className='card';
    btn.innerHTML = `<div><b>${a.name}</b></div><div class="stat">${a.desc}</div>`;
    btn.onclick = ()=>{
      // apply and heal small
      const h=state.hero;
      a.apply(h);
      state.artifacts.push(a.name);
      h.hp = Math.min(h.hpMax, h.hp + Math.floor(h.hpMax*0.2));
      log(`🏵️ حصلت على: ${a.name}. تم شفاء بسيط.`);
      $('rewards').style.display='none';
      nextEnemy();
      updateHero();
    };
    list.appendChild(btn);
  }
}

function death(){
  log('💀 متَّ… موت دائم. الشخصية ضاعت للأبد.');
  gameOver(true);
}

function gameOver(dead){
  $('run').style.display='none';
  $('menu').style.display='block';
  if (dead){
    alert('موت دائم! عد إلى القائمة للاستدعاء من جديد.');
  }
}

// PWA install
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; });
function installPWA(){
  if (deferredPrompt){ deferredPrompt.prompt(); deferredPrompt.userChoice; }
  else alert('من فضلك استخدم "إضافة إلى الشاشة الرئيسية" من المتصفح.');
}

// Init
window.addEventListener('load', ()=>{
  $('best').textContent=state.best; $('best2').textContent=state.best;
  if ('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }
});
</script>
</body>
</html>

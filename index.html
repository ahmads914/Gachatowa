<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>Tower Gacha: Permadeath</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0e0e16">
<style>
  :root {
    --bg:#14141e; --panel:#1d1d2a; --text:#f5f7ff; --muted:#b3b6c9;
    --acc:#6ae0ff; --good:#5ee075; --bad:#ff6a6a; --warn:#ffd56a;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto; }
  #app{max-width:700px;margin:0 auto;padding:12px 12px 80px;}
  h1{font-size:22px;margin:10px 0 6px}
  .card{background:var(--panel);border-radius:14px;padding:12px;margin:10px 0;box-shadow:0 6px 20px rgba(0,0,0,.4)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .space{height:6px}
  button{background:#252535;color:var(--text);border:1px solid #34344a;border-radius:12px;padding:12px 14px;font-size:16px}
  button.primary{background:linear-gradient(135deg,#2b3e5a,#1f6b7d);border:none}
  button:active{transform:scale(.98)}
  .pill{padding:6px 10px;border-radius:999px;background:#252535;color:var(--muted);font-size:13px}
  .stars{letter-spacing:2px}
  .log{max-height:180px;overflow:auto;background:#12121a;border-radius:10px;padding:10px;border:1px solid #2a2a3a}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .stat{font-size:14px;color:var(--muted)}
  .bar{height:10px;background:#0f0f18;border-radius:8px;overflow:hidden}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,#6ae0ff,#a6ffe4)}
  .center{text-align:center}
  .enemy{border:1px solid #3a3a52}
  .artifact{border:1px dashed #3a3a52}
  .foot{position:fixed;bottom:0;left:0;right:0;background:rgba(13,13,20,.9);backdrop-filter: blur(6px);padding:10px;border-top:1px solid #2a2a3a}
</style>
</head>
<body>
<div id="app">
  <div class="card center">
    <h1>ğŸ—¼ Tower Gacha: Permadeath</h1>
    <div class="pill">Ù…ÙˆØª Ø¯Ø§Ø¦Ù… â€¢ ØºØ§Ø´Ø§ Ø®ÙÙŠÙ â€¢ ØªØ³Ù„Ù‚ Ø·ÙˆØ§Ø¨Ù‚</div>
    <div class="space"></div>
    <div id="menu">
      <p>Ø§Ø®ØªØ± Ø¨Ø·Ù„Ù‹Ø§ Ø¹Ø¨Ø± Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ (ØºØ§Ø´Ø§). Ø¥Ø°Ø§ Ù…ØªÙ‘â€¦ ØªÙØ¹Ø§Ø¯ Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©. Ø­Ø·Ù… Ø£ÙØ¶Ù„ Ø·Ø§Ø¨Ù‚ Ù„Ùƒ!</p>
      <div class="space"></div>
      <button class="primary" onclick="gacha()">ğŸ² Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø£Ø¨Ø·Ø§Ù„</button>
      <div class="space"></div>
      <div>Ø£ÙØ¶Ù„ Ø·Ø§Ø¨Ù‚: <b id="best">0</b></div>
    </div>
  </div>

  <div id="gacha" class="card" style="display:none">
    <h1>ğŸ´ Ø§Ø®ØªØ± Ø¨Ø·Ù„Ùƒ</h1>
    <div id="gachaList" class="grid"></div>
    <div class="space"></div>
    <button onclick="backToMenu()">Ø±Ø¬ÙˆØ¹</button>
  </div>

  <div id="run" style="display:none">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>Ø§Ù„Ø·Ø§Ø¨Ù‚ <b id="floor">1</b></div>
        <div>ğŸ“œ Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ø£Ø«Ø±ÙŠØ©: <span id="artCount">0</span></div>
        <div>ğŸ… Ø£ÙØ¶Ù„ Ø·Ø§Ø¨Ù‚: <span id="best2">0</span></div>
      </div>
      <div class="space"></div>
      <div class="row">
        <div class="card enemy" style="flex:1">
          <div class="row" style="justify-content:space-between">
            <div>ğŸ‘¾ <b id="eName"></b></div><div class="pill">ATK <span id="eAtk"></span></div>
          </div>
          <div class="stat">HP <span id="eHp"></span>/<span id="eHpMax"></span></div>
          <div class="bar"><span id="eHpBar" style="width:100%"></span></div>
        </div>
        <div class="card" style="flex:1">
          <div class="row" style="justify-content:space-between">
            <div>ğŸ§‘â€ğŸš€ <b id="pName"></b> <span class="stars" id="pStars"></span></div>
            <div class="pill" id="pClass"></div>
          </div>
          <div class="stat">HP <span id="pHp"></span>/<span id="pHpMax"></span></div>
          <div class="bar"><span id="pHpBar" style="width:100%"></span></div>
          <div class="stat">ATK <span id="pAtk"></span> â€¢ DEF <span id="pDef"></span> â€¢ SPD <span id="pSpd"></span></div>
          <div class="stat">Ù…Ù‡Ø§Ø±Ø©: <b id="pSkill"></b> (<span id="skillCd">Ø¬Ø§Ù‡Ø²Ø©</span>)</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h1>Ø§Ù„Ø£ÙˆØ§Ù…Ø±</h1>
      <div class="grid">
        <button onclick="actAttack()" class="primary">âš”ï¸ Ù‡Ø¬ÙˆÙ…</button>
        <button onclick="actSkill()">âœ¨ Ù…Ù‡Ø§Ø±Ø©</button>
        <button onclick="actDefend()">ğŸ›¡ï¸ Ø¯ÙØ§Ø¹</button>
        <button onclick="actRetreat()">ğŸ³ï¸ Ù‡Ø±ÙˆØ¨</button>
      </div>
      <div class="space"></div>
      <div class="log" id="log"></div>
    </div>

    <div id="rewards" class="card artifact" style="display:none">
      <h1>ğŸµï¸ Ø§Ø®ØªØ± Ù‚Ø·Ø¹Ø© Ø£Ø«Ø±ÙŠØ©</h1>
      <div id="artifactList" class="grid"></div>
    </div>
  </div>

</div>

<div class="foot row center">
  <div style="flex:1">Ù†ØµÙŠØ­Ø©: Ø§Ù„Ù…Ù‡Ø§Ø±Ø© Ø£ÙØ¶Ù„ Ø¶Ø¯ Ø§Ù„Ø²Ø¹Ù…Ø§Ø¡ØŒ Ù„ÙƒÙ† Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¨Ø±ÙŠØ¯!</div>
  <button onclick="installPWA()">â¬‡ï¸ ØªØ«Ø¨ÙŠØª</button>
</div>

<script>
// --- State ---
let state = {
  best: parseInt(localStorage.getItem('tg_best')||'0',10),
  floor: 1, artifacts: [], hero:null, enemy:null, skillCd:0, defending:false
};
const classes = [
  {name:'Ù…Ø­Ø§Ø±Ø¨', key:'warrior', skill:'Ø¶Ø±Ø¨Ø© Ù‚Ø§Ø¶ÙŠØ© (250% Ø¶Ø±Ø±)', mult: {hp:1.2, atk:1.1, def:1.1, spd:1.0}, cd:3},
  {name:'Ø±Ø§Ù…ÙŠ', key:'archer',  skill:'Ø³ÙŠÙ„ Ø§Ù„Ø³Ù‡Ø§Ù… (3Ã—100%)', mult: {hp:1.0, atk:1.25, def:0.9, spd:1.1}, cd:3},
  {name:'Ø³Ø§Ø­Ø±', key:'mage',    skill:'Ø§Ù†ÙØ¬Ø§Ø± Ø³Ø­Ø±ÙŠ (200% ÙŠØªØ¬Ø§Ù‡Ù„ 50% Ø¯ÙØ§Ø¹)', mult: {hp:0.9, atk:1.35, def:0.8, spd:1.0}, cd:4},
  {name:'ÙØ§Ø±Ø³', key:'knight',  skill:'Ø§Ù†Ø¯ÙØ§Ø¹ Ø¯Ø±Ø¹ÙŠ (150% + Ø¯Ø±Ø¹ Ù…Ø¤Ù‚Øª)', mult: {hp:1.3, atk:1.0, def:1.3, spd:0.9}, cd:4}
];
const names = ['Ù„ÙŠØ§Ù†','Ø³ÙØ±Ø§Ù†','ÙƒÙÙŠØ§Ù†','Ø£Ø±ÙˆÙ‰','ØºØ³Ù‘Ø§Ù†','Ù„ÙŠØ«','Ø±ÙŠÙ…','Ù‡Ø§Ù„Ø©','Ù†Ø§ÙŠÙ','Ù†Ø¯ÙŠÙ…','ØªØ§Ø±Ø§','Ù†ÙŠØ±Ù','Ø¬ÙˆØ§Ø¯','Ø³ÙŠØ§','Ù…Ø§Ù‡Ø±','Ù„ÙŠÙ†'];
const starRates = [ // cumulative
  {stars:1,p:0.5},{stars:2,p:0.8},{stars:3,p:0.95},{stars:4,p:0.995},{stars:5,p:1.0}
];
const artifactsPool = [
  {name:'Ø®Ø§ØªÙ… Ø§Ù„ØµÙŠÙ‘Ø§Ø¯',desc:'+10% Ù‡Ø¬ÙˆÙ…', apply:h=>h.atk*=1.10},
  {name:'ÙˆØ´Ø§Ø­ Ø§Ù„ÙÙˆÙ„Ø§Ø°',desc:'+12% Ø¯ÙØ§Ø¹', apply:h=>h.def*=1.12},
  {name:'Ù‚Ù„Ø¨ Ø§Ù„Ø¹Ù†Ù‚Ø§Ø¡ (Ù…Ù‚ÙŠØ¯)',desc:'+15% Ù†Ù‚Ø§Ø· Ø­ÙŠØ§Ø© ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰ (Ù„Ø§ ÙŠÙØ­ÙŠÙŠ)', apply:h=>h.hpMax*=1.15},
  {name:'Ø¹Ù‚Ø¯ Ø§Ù„Ø³Ø±Ø¹Ø©',desc:'+8% Ø³Ø±Ø¹Ø©', apply:h=>h.spd*=1.08},
  {name:'ÙƒØªØ§Ø¨ Ø§Ù„ØªØ±ÙƒÙŠØ²',desc:'-1 ØªØ¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ù‡Ø§Ø±Ø© (Ø­Ø¯ Ø£Ø¯Ù†Ù‰ 1)', apply:h=>h.cd=Math.max(1,h.cd-1)},
  {name:'Ø³ÙŠÙ Ø§Ù„Ø¹Ø§ØµÙØ©',desc:'Ù…Ù‡Ø§Ø±Ø© ØªØ³Ø¨Ø¨ +40% Ø¶Ø±Ø±', apply:h=>h.skillMult*=1.4},
  {name:'Ø¯Ø±Ø¹ Ø§Ù„ÙˆØµØ§ÙŠØ©',desc:'Ø§Ù„Ø¯ÙØ§Ø¹ ÙŠÙ‚Ù„Ù„ Ø¶Ø±Ø± Ø§Ù„Ø¹Ø¯Ùˆ 60%', apply:h=>h.defendRed=0.6}
];

function $(id){return document.getElementById(id);}
function log(t){const el=$('log'); el.innerHTML += '<div>â€¢ '+t+'</div>'; el.scrollTop=el.scrollHeight;}
function rnd(){return Math.random();}
function pick(arr){return arr[Math.floor(rnd()*arr.length)];}

function saveBest(){ localStorage.setItem('tg_best', String(state.best)); $('best').textContent=state.best; $('best2').textContent=state.best; }

function backToMenu(){
  $('gacha').style.display='none';
  $('menu').style.display='block';
}

function gacha(){
  $('menu').style.display='none';
  $('gacha').style.display='block';
  const list = $('gachaList'); list.innerHTML='';
  for(let i=0;i<3;i++){
    const cls = pick(classes);
    const roll = rnd();
    let stars = 1;
    for (const r of starRates){ if (roll<=r.p){ stars=r.stars; break; } }
    const base = 50 + stars*25;
    const hero = {
      name: pick(names),
      class: cls.name, clsKey: cls.key, skill: cls.skill, cdBase: cls.cd, cd: cls.cd,
      stars, skillMult: 1.0, defendRed: 0.5,
      hpMax: Math.floor(base*cls.mult.hp),
      atk: Math.floor(base*cls.mult.atk*0.8),
      def: Math.floor(base*cls.mult.def*0.7),
      spd: Math.floor(10*cls.mult.spd)
    };
    hero.hp = hero.hpMax;
    const card = document.createElement('div');
    card.className='card';
    card.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div><b>${hero.name}</b> <span class="stars">${'â˜…'.repeat(hero.stars)}</span></div>
        <div class="pill">${hero.class}</div>
      </div>
      <div class="stat">HP ${hero.hpMax} â€¢ ATK ${hero.atk} â€¢ DEF ${hero.def} â€¢ SPD ${hero.spd}</div>
      <div class="stat">Ù…Ù‡Ø§Ø±Ø©: <b>${hero.skill}</b> (ØªØ¨Ø±ÙŠØ¯ ${hero.cdBase})</div>
      <div class="space"></div>
      <button class="primary">Ø§Ø®ØªØ±</button>
    `;
    card.querySelector('button').onclick = ()=>startRun(hero);
    list.appendChild(card);
  }
}

function startRun(hero){
  state.floor=1; state.artifacts=[]; state.hero=hero; state.skillCd=0; state.defending=false;
  $('gacha').style.display='none';
  $('run').style.display='block';
  $('rewards').style.display='none';
  $('pName').textContent = hero.name;
  $('pStars').textContent = 'â˜…'.repeat(hero.stars);
  $('pClass').textContent = hero.class;
  $('pSkill').textContent = hero.skill;
  updateHero();
  nextEnemy();
  $('log').innerHTML=''; log('Ø¨Ø¯Ø£Øª Ø§Ù„Ø±Ø­Ù„Ø©!');
}

function updateHero(){
  const h = state.hero;
  $('pHp').textContent = Math.max(0,Math.floor(h.hp));
  $('pHpMax').textContent = Math.floor(h.hpMax);
  $('pAtk').textContent = Math.floor(h.atk);
  $('pDef').textContent = Math.floor(h.def);
  $('pSpd').textContent = Math.floor(h.spd);
  $('pHpBar').style.width = Math.max(0, (h.hp/h.hpMax*100))+'%';
  $('skillCd').textContent = state.skillCd>0 ? ('ØªØ¨Ø±ÙŠØ¯: '+state.skillCd) : 'Ø¬Ø§Ù‡Ø²Ø©';
  $('artCount').textContent = state.artifacts.length;
  $('floor').textContent = state.floor;
  $('best2').textContent = state.best;
}

function nextEnemy(){
  const f = state.floor;
  const hp = Math.floor(80 + f*35 * (1 + (f%10===0?1.2:0)));
  const atk = Math.floor(20 + f*8);
  const name = f%10===0 ? 'Ø²Ø¹ÙŠÙ… Ø§Ù„Ø·Ø§Ø¨Ù‚' : pick(['Ø¸ÙÙ„ Ù…Ø­Ø§Ø±Ø¨','Ø¢ÙƒÙ„ Ù†ÙÙÙˆØ³','Ø­Ø§Ø±Ø³ Ø§Ù„Ø·Ø§Ø¨Ù‚','Ø³Ø§Ø­Ø± ØºØ§Ù…Ø¶','Ù‡ÙŠÙƒÙ„ Ø¹Ø¸Ù…ÙŠ']);
  state.enemy = {name, hpMax:hp, hp:hp, atk};
  $('eName').textContent = state.enemy.name;
  $('eHp').textContent = state.enemy.hp;
  $('eHpMax').textContent = state.enemy.hpMax;
  $('eAtk').textContent = state.enemy.atk;
  $('eHpBar').style.width = '100%';
}

function enemyTurn(){
  const e = state.enemy, h = state.hero;
  if (e.hp<=0) return;
  let dmg = Math.max(1, Math.floor(e.atk - h.def*0.3));
  if (state.defending) dmg = Math.floor(dmg * (h.defendRed||0.5));
  h.hp -= dmg;
  log(`ğŸ‘¾ Ø§Ù„Ø¹Ø¯Ùˆ ÙŠÙ„Ø­Ù‚ ${dmg} Ø¶Ø±Ø±Ù‹Ø§!`);
  state.defending=false;
  if (h.hp<=0){
    h.hp=0; updateHero(); death();
  } else {
    updateHero();
  }
}

function actAttack(){
  const h=state.hero, e=state.enemy;
  let dmg = Math.max(1, Math.floor(h.atk - e.atk*0.1));
  e.hp -= dmg;
  log(`âš”ï¸ Ù‡Ø§Ø¬Ù…Øª ÙˆØ£Ù„Ø­Ù‚Øª ${dmg} Ø¶Ø±Ø±Ù‹Ø§.`);
  postPlayerAction();
}

function actSkill(){
  const h=state.hero, e=state.enemy;
  if (state.skillCd>0){ log('â³ Ø§Ù„Ù…Ù‡Ø§Ø±Ø© ÙÙŠ ØªØ¨Ø±ÙŠØ¯.'); return; }
  let dmg=0;
  if (h.clsKey==='warrior'){ dmg = Math.floor(h.atk*2.5); }
  if (h.clsKey==='archer'){ dmg = Math.floor(h.atk*1.0)*3; }
  if (h.clsKey==='mage'){ dmg = Math.floor(h.atk*2.0 + h.atk*0.5); /* ignore def abstracted */ }
  if (h.clsKey==='knight'){ dmg = Math.floor(h.atk*1.5); state.defending=true; }
  dmg = Math.floor(dmg * (h.skillMult||1));
  e.hp -= dmg;
  log(`âœ¨ Ø§Ø³ØªØ®Ø¯Ù…Øª Ø§Ù„Ù…Ù‡Ø§Ø±Ø© ÙˆØ£Ù„Ø­Ù‚Øª ${dmg} Ø¶Ø±Ø±Ù‹Ø§!`);
  state.skillCd = h.cd;
  postPlayerAction();
}

function actDefend(){
  state.defending=true;
  log('ğŸ›¡ï¸ Ø§ØªØ®Ø°Øª ÙˆØ¶Ø¹ÙŠØ© Ø§Ù„Ø¯ÙØ§Ø¹ (Ø¶Ø±Ø± Ø£Ù‚Ù„ ÙÙŠ Ù‡Ø¬Ù…Ø© Ø§Ù„Ø¹Ø¯Ùˆ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©).');
  postPlayerAction();
}

function actRetreat(){
  log('ğŸ³ï¸ Ø§Ù†Ø³Ø­Ø¨Øªâ€¦ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø±Ø­Ù„Ø©.');
  gameOver(false);
}

function postPlayerAction(){
  const e=state.enemy, h=state.hero;
  if (state.skillCd>0) state.skillCd--;
  if (e.hp<=0){
    e.hp=0;
    $('eHp').textContent=e.hp; $('eHpBar').style.width='0%';
    log('ğŸ Ù‡Ø²Ù…Øª Ø§Ù„Ø¹Ø¯Ùˆ!');
    // rewards
    state.floor++;
    if (state.floor-1 > state.best){ state.best = state.floor-1; saveBest(); }
    rewardPhase();
  } else {
    $('eHp').textContent = e.hp; $('eHpBar').style.width = (e.hp/e.hpMax*100)+'%';
    // enemy acts
    setTimeout(enemyTurn, 200);
  }
  updateHero();
}

function rewardPhase(){
  $('rewards').style.display='block';
  const list = $('artifactList'); list.innerHTML='';
  const opts = [];
  while (opts.length<3){
    const a = pick(artifactsPool);
    if (!opts.includes(a)) opts.push(a);
  }
  for (const a of opts){
    const btn = document.createElement('button');
    btn.className='card';
    btn.innerHTML = `<div><b>${a.name}</b></div><div class="stat">${a.desc}</div>`;
    btn.onclick = ()=>{
      // apply and heal small
      const h=state.hero;
      a.apply(h);
      state.artifacts.push(a.name);
      h.hp = Math.min(h.hpMax, h.hp + Math.floor(h.hpMax*0.2));
      log(`ğŸµï¸ Ø­ØµÙ„Øª Ø¹Ù„Ù‰: ${a.name}. ØªÙ… Ø´ÙØ§Ø¡ Ø¨Ø³ÙŠØ·.`);
      $('rewards').style.display='none';
      nextEnemy();
      updateHero();
    };
    list.appendChild(btn);
  }
}

function death(){
  log('ğŸ’€ Ù…ØªÙ‘Ùâ€¦ Ù…ÙˆØª Ø¯Ø§Ø¦Ù…. Ø§Ù„Ø´Ø®ØµÙŠØ© Ø¶Ø§Ø¹Øª Ù„Ù„Ø£Ø¨Ø¯.');
  gameOver(true);
}

function gameOver(dead){
  $('run').style.display='none';
  $('menu').style.display='block';
  if (dead){
    alert('Ù…ÙˆØª Ø¯Ø§Ø¦Ù…! Ø¹Ø¯ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯.');
  }
}

// PWA install
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; });
function installPWA(){
  if (deferredPrompt){ deferredPrompt.prompt(); deferredPrompt.userChoice; }
  else alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø³ØªØ®Ø¯Ù… "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­.');
}

// Init
window.addEventListener('load', ()=>{
  $('best').textContent=state.best; $('best2').textContent=state.best;
  if ('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }
});
</script>
</body>
</html>
